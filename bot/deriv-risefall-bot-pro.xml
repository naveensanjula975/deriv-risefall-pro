<xml xmlns="https://developers.google.com/blockly/xml">
  <variables>
    <!-- ==================== CONFIGURATION VARIABLES ==================== -->
    <!-- Trading Settings -->
    <variable id="base_stake">base_stake</variable>
    <variable id="current_stake">current_stake</variable>
    <variable id="contract_type">contract_type</variable>
    <variable id="duration_value">duration_value</variable>
    <variable id="duration_type">duration_type</variable>
    <variable id="symbol">symbol</variable>
    
    <!-- Martingale Settings -->
    <variable id="martingale_enabled">martingale_enabled</variable>
    <variable id="martingale_multiplier">martingale_multiplier</variable>
    <variable id="max_martingale_steps">max_martingale_steps</variable>
    <variable id="current_martingale_step">current_martingale_step</variable>
    
    <!-- Risk Management -->
    <variable id="take_profit">take_profit</variable>
    <variable id="stop_loss">stop_loss</variable>
    <variable id="max_consecutive_losses">max_consecutive_losses</variable>
    <variable id="min_balance">min_balance</variable>
    
    <!-- Tracking Variables -->
    <variable id="initial_balance">initial_balance</variable>
    <variable id="current_balance">current_balance</variable>
    <variable id="total_profit">total_profit</variable>
    <variable id="total_trades">total_trades</variable>
    <variable id="win_count">win_count</variable>
    <variable id="loss_count">loss_count</variable>
    <variable id="consecutive_losses">consecutive_losses</variable>
    <variable id="last_profit">last_profit</variable>
    
    <!-- Bot State -->
    <variable id="bot_running">bot_running</variable>
    <variable id="stop_reason">stop_reason</variable>
    
    <!-- Telegram Settings -->
    <variable id="telegram_enabled">telegram_enabled</variable>
    <variable id="telegram_token">telegram_token</variable>
    <variable id="telegram_chat_id">telegram_chat_id</variable>
  </variables>

  <!-- ==================== MAIN BOT LOGIC ==================== -->
  
  <!-- INITIALIZATION BLOCK -->
  <block type="loader" id="initialization" x="50" y="50">
    <statement name="INITIALIZATION">
      <block type="block_holder" id="init_holder">
        <statement name="CONTENTS">
          
          <!-- ===== TRADING CONFIGURATION ===== -->
          <!-- Base Stake Amount -->
          <block type="variables_set" id="set_base_stake">
            <field name="VAR" id="base_stake">base_stake</field>
            <value name="VALUE">
              <block type="math_number">
                <field name="NUM">1</field>
              </block>
            </value>
            <next>
              <!-- Current Stake (starts same as base) -->
              <block type="variables_set" id="set_current_stake">
                <field name="VAR" id="current_stake">current_stake</field>
                <value name="VALUE">
                  <block type="variables_get">
                    <field name="VAR" id="base_stake">base_stake</field>
                  </block>
                </value>
                <next>
                  <!-- Contract Duration -->
                  <block type="variables_set" id="set_duration">
                    <field name="VAR" id="duration_value">duration_value</field>
                    <value name="VALUE">
                      <block type="math_number">
                        <field name="NUM">1</field>
                      </block>
                    </value>
                    <next>
                      <!-- Duration Type: t=ticks, s=seconds, m=minutes -->
                      <block type="variables_set" id="set_duration_type">
                        <field name="VAR" id="duration_type">duration_type</field>
                        <value name="VALUE">
                          <block type="text">
                            <field name="TEXT">t</field>
                          </block>
                        </value>
                        <next>
                          <!-- Trading Symbol -->
                          <block type="variables_set" id="set_symbol">
                            <field name="VAR" id="symbol">symbol</field>
                            <value name="VALUE">
                              <block type="text">
                                <field name="TEXT">R_100</field>
                              </block>
                            </value>
                            <next>
                              
                              <!-- ===== MARTINGALE CONFIGURATION ===== -->
                              <!-- Enable Martingale -->
                              <block type="variables_set" id="set_martingale_enabled">
                                <field name="VAR" id="martingale_enabled">martingale_enabled</field>
                                <value name="VALUE">
                                  <block type="logic_boolean">
                                    <field name="BOOL">TRUE</field>
                                  </block>
                                </value>
                                <next>
                                  <!-- Martingale Multiplier -->
                                  <block type="variables_set" id="set_multiplier">
                                    <field name="VAR" id="martingale_multiplier">martingale_multiplier</field>
                                    <value name="VALUE">
                                      <block type="math_number">
                                        <field name="NUM">2</field>
                                      </block>
                                    </value>
                                    <next>
                                      <!-- Max Martingale Steps -->
                                      <block type="variables_set" id="set_max_steps">
                                        <field name="VAR" id="max_martingale_steps">max_martingale_steps</field>
                                        <value name="VALUE">
                                          <block type="math_number">
                                            <field name="NUM">5</field>
                                          </block>
                                        </value>
                                        <next>
                                          <!-- Current Step Counter -->
                                          <block type="variables_set" id="set_current_step">
                                            <field name="VAR" id="current_martingale_step">current_martingale_step</field>
                                            <value name="VALUE">
                                              <block type="math_number">
                                                <field name="NUM">0</field>
                                              </block>
                                            </value>
                                            <next>
                                              
                                              <!-- ===== RISK MANAGEMENT CONFIGURATION ===== -->
                                              <!-- Take Profit Target -->
                                              <block type="variables_set" id="set_take_profit">
                                                <field name="VAR" id="take_profit">take_profit</field>
                                                <value name="VALUE">
                                                  <block type="math_number">
                                                    <field name="NUM">50</field>
                                                  </block>
                                                </value>
                                                <next>
                                                  <!-- Stop Loss Limit -->
                                                  <block type="variables_set" id="set_stop_loss">
                                                    <field name="VAR" id="stop_loss">stop_loss</field>
                                                    <value name="VALUE">
                                                      <block type="math_number">
                                                        <field name="NUM">25</field>
                                                      </block>
                                                    </value>
                                                    <next>
                                                      <!-- Max Consecutive Losses -->
                                                      <block type="variables_set" id="set_max_losses">
                                                        <field name="VAR" id="max_consecutive_losses">max_consecutive_losses</field>
                                                        <value name="VALUE">
                                                          <block type="math_number">
                                                            <field name="NUM">5</field>
                                                          </block>
                                                        </value>
                                                        <next>
                                                          <!-- Minimum Balance Threshold -->
                                                          <block type="variables_set" id="set_min_balance">
                                                            <field name="VAR" id="min_balance">min_balance</field>
                                                            <value name="VALUE">
                                                              <block type="math_number">
                                                                <field name="NUM">10</field>
                                                              </block>
                                                            </value>
                                                            <next>
                                                              
                                                              <!-- ===== TRACKING VARIABLES INITIALIZATION ===== -->
                                                              <!-- Initial Balance -->
                                                              <block type="variables_set" id="set_initial_balance">
                                                                <field name="VAR" id="initial_balance">initial_balance</field>
                                                                <value name="VALUE">
                                                                  <block type="balance">
                                                                    <field name="BALANCE_TYPE">STR_BALANCE</field>
                                                                  </block>
                                                                </value>
                                                                <next>
                                                                  <!-- Current Balance -->
                                                                  <block type="variables_set" id="set_current_balance">
                                                                    <field name="VAR" id="current_balance">current_balance</field>
                                                                    <value name="VALUE">
                                                                      <block type="balance">
                                                                        <field name="BALANCE_TYPE">STR_BALANCE</field>
                                                                      </block>
                                                                    </value>
                                                                    <next>
                                                                      <!-- Total Profit -->
                                                                      <block type="variables_set" id="set_total_profit">
                                                                        <field name="VAR" id="total_profit">total_profit</field>
                                                                        <value name="VALUE">
                                                                          <block type="math_number">
                                                                            <field name="NUM">0</field>
                                                                          </block>
                                                                        </value>
                                                                        <next>
                                                                          <!-- Total Trades -->
                                                                          <block type="variables_set" id="set_total_trades">
                                                                            <field name="VAR" id="total_trades">total_trades</field>
                                                                            <value name="VALUE">
                                                                              <block type="math_number">
                                                                                <field name="NUM">0</field>
                                                                              </block>
                                                                            </value>
                                                                            <next>
                                                                              <!-- Win Count -->
                                                                              <block type="variables_set" id="set_win_count">
                                                                                <field name="VAR" id="win_count">win_count</field>
                                                                                <value name="VALUE">
                                                                                  <block type="math_number">
                                                                                    <field name="NUM">0</field>
                                                                                  </block>
                                                                                </value>
                                                                                <next>
                                                                                  <!-- Loss Count -->
                                                                                  <block type="variables_set" id="set_loss_count">
                                                                                    <field name="VAR" id="loss_count">loss_count</field>
                                                                                    <value name="VALUE">
                                                                                      <block type="math_number">
                                                                                        <field name="NUM">0</field>
                                                                                      </block>
                                                                                    </value>
                                                                                    <next>
                                                                                      <!-- Consecutive Losses -->
                                                                                      <block type="variables_set" id="set_consecutive_losses">
                                                                                        <field name="VAR" id="consecutive_losses">consecutive_losses</field>
                                                                                        <value name="VALUE">
                                                                                          <block type="math_number">
                                                                                            <field name="NUM">0</field>
                                                                                          </block>
                                                                                        </value>
                                                                                        <next>
                                                                                          <!-- Last Profit -->
                                                                                          <block type="variables_set" id="set_last_profit">
                                                                                            <field name="VAR" id="last_profit">last_profit</field>
                                                                                            <value name="VALUE">
                                                                                              <block type="math_number">
                                                                                                <field name="NUM">0</field>
                                                                                              </block>
                                                                                            </value>
                                                                                            <next>
                                                                                              
                                                                                              <!-- ===== BOT STATE ===== -->
                                                                                              <!-- Bot Running State -->
                                                                                              <block type="variables_set" id="set_bot_running">
                                                                                                <field name="VAR" id="bot_running">bot_running</field>
                                                                                                <value name="VALUE">
                                                                                                  <block type="logic_boolean">
                                                                                                    <field name="BOOL">TRUE</field>
                                                                                                  </block>
                                                                                                </value>
                                                                                                <next>
                                                                                                  <!-- Stop Reason -->
                                                                                                  <block type="variables_set" id="set_stop_reason">
                                                                                                    <field name="VAR" id="stop_reason">stop_reason</field>
                                                                                                    <value name="VALUE">
                                                                                                      <block type="text">
                                                                                                        <field name="TEXT"></field>
                                                                                                      </block>
                                                                                                    </value>
                                                                                                    <next>
                                                                                                      
                                                                                                      <!-- ===== TELEGRAM CONFIGURATION ===== -->
                                                                                                      <!-- Telegram Enabled -->
                                                                                                      <block type="variables_set" id="set_telegram_enabled">
                                                                                                        <field name="VAR" id="telegram_enabled">telegram_enabled</field>
                                                                                                        <value name="VALUE">
                                                                                                          <block type="logic_boolean">
                                                                                                            <field name="BOOL">FALSE</field>
                                                                                                          </block>
                                                                                                        </value>
                                                                                                        <next>
                                                                                                          <!-- Telegram Bot Token -->
                                                                                                          <block type="variables_set" id="set_telegram_token">
                                                                                                            <field name="VAR" id="telegram_token">telegram_token</field>
                                                                                                            <value name="VALUE">
                                                                                                              <block type="text">
                                                                                                                <field name="TEXT">YOUR_BOT_TOKEN</field>
                                                                                                              </block>
                                                                                                            </value>
                                                                                                            <next>
                                                                                                              <!-- Telegram Chat ID -->
                                                                                                              <block type="variables_set" id="set_telegram_chat_id">
                                                                                                                <field name="VAR" id="telegram_chat_id">telegram_chat_id</field>
                                                                                                                <value name="VALUE">
                                                                                                                  <block type="text">
                                                                                                                    <field name="TEXT">YOUR_CHAT_ID</field>
                                                                                                                  </block>
                                                                                                                </value>
                                                                                                                <next>
                                                                                                                  <!-- Notify Bot Started -->
                                                                                                                  <block type="notify">
                                                                                                                    <field name="NOTIFICATION_TYPE">success</field>
                                                                                                                    <value name="MESSAGE">
                                                                                                                      <block type="text">
                                                                                                                        <field name="TEXT">ü§ñ Bot Started - Rise/Fall Pro v1.0</field>
                                                                                                                      </block>
                                                                                                                    </value>
                                                                                                                  </block>
                                                                                                                </next>
                                                                                                              </block>
                                                                                                            </next>
                                                                                                          </block>
                                                                                                        </next>
                                                                                                      </block>
                                                                                                    </next>
                                                                                                  </block>
                                                                                                </next>
                                                                                              </block>
                                                                                            </next>
                                                                                          </block>
                                                                                        </next>
                                                                                      </block>
                                                                                    </next>
                                                                                  </block>
                                                                                </next>
                                                                              </block>
                                                                            </next>
                                                                          </block>
                                                                        </next>
                                                                      </block>
                                                                    </next>
                                                                  </block>
                                                                </next>
                                                              </block>
                                                            </next>
                                                          </block>
                                                        </next>
                                                      </block>
                                                    </next>
                                                  </block>
                                                </next>
                                              </block>
                                            </next>
                                          </block>
                                        </next>
                                      </block>
                                    </next>
                                  </block>
                                </next>
                              </block>
                            </next>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </next>
          </block>
        </statement>
      </block>
    </statement>

    <!-- TRADE PARAMETERS BLOCK -->
    <statement name="TRADE_OPTIONS">
      <block type="tradeOptions">
        <field name="DURATIONTYPE_LIST">t</field>
        <field name="CURRENCY_LIST">USD</field>
        <field name="TRADETYPE_LIST">CALL</field>
        <value name="DURATION">
          <block type="variables_get">
            <field name="VAR" id="duration_value">duration_value</field>
          </block>
        </value>
        <value name="AMOUNT">
          <block type="variables_get">
            <field name="VAR" id="current_stake">current_stake</field>
          </block>
        </value>
        <value name="MARKET">
          <block type="variables_get">
            <field name="VAR" id="symbol">symbol</field>
          </block>
        </value>
      </block>
    </statement>

    <!-- BEFORE PURCHASE (Pre-trade checks) -->
    <statement name="BEFOREPURCHASE_STACK">
      <block type="before_purchase">
        <statement name="BEFOREPURCHASE_STACK">
          <block type="block_holder" id="before_purchase_holder">
            <statement name="CONTENTS">
              
              <!-- Check if bot should continue running -->
              <block type="controls_if" id="check_bot_running">
                <mutation else="1"/>
                <value name="IF0">
                  <block type="variables_get">
                    <field name="VAR" id="bot_running">bot_running</field>
                  </block>
                </value>
                <statement name="DO0">
                  
                  <!-- ===== PRE-TRADE RISK CHECKS ===== -->
                  
                  <!-- Check 1: Take Profit Reached -->
                  <block type="controls_if" id="check_take_profit">
                    <value name="IF0">
                      <block type="logic_compare">
                        <field name="OP">GTE</field>
                        <value name="A">
                          <block type="variables_get">
                            <field name="VAR" id="total_profit">total_profit</field>
                          </block>
                        </value>
                        <value name="B">
                          <block type="variables_get">
                            <field name="VAR" id="take_profit">take_profit</field>
                          </block>
                        </value>
                      </block>
                    </value>
                    <statement name="DO0">
                      <block type="variables_set">
                        <field name="VAR" id="bot_running">bot_running</field>
                        <value name="VALUE">
                          <block type="logic_boolean">
                            <field name="BOOL">FALSE</field>
                          </block>
                        </value>
                        <next>
                          <block type="variables_set">
                            <field name="VAR" id="stop_reason">stop_reason</field>
                            <value name="VALUE">
                              <block type="text">
                                <field name="TEXT">Take Profit Reached</field>
                              </block>
                            </value>
                            <next>
                              <block type="notify">
                                <field name="NOTIFICATION_TYPE">success</field>
                                <value name="MESSAGE">
                                  <block type="text">
                                    <field name="TEXT">üéØ Take Profit Reached! Bot Stopped.</field>
                                  </block>
                                </value>
                              </block>
                            </next>
                          </block>
                        </next>
                      </block>
                    </statement>
                    <next>
                      
                      <!-- Check 2: Stop Loss Triggered -->
                      <block type="controls_if" id="check_stop_loss">
                        <value name="IF0">
                          <block type="logic_compare">
                            <field name="OP">LTE</field>
                            <value name="A">
                              <block type="variables_get">
                                <field name="VAR" id="total_profit">total_profit</field>
                              </block>
                            </value>
                            <value name="B">
                              <block type="math_arithmetic">
                                <field name="OP">MULTIPLY</field>
                                <value name="A">
                                  <block type="variables_get">
                                    <field name="VAR" id="stop_loss">stop_loss</field>
                                  </block>
                                </value>
                                <value name="B">
                                  <block type="math_number">
                                    <field name="NUM">-1</field>
                                  </block>
                                </value>
                              </block>
                            </value>
                          </block>
                        </value>
                        <statement name="DO0">
                          <block type="variables_set">
                            <field name="VAR" id="bot_running">bot_running</field>
                            <value name="VALUE">
                              <block type="logic_boolean">
                                <field name="BOOL">FALSE</field>
                              </block>
                            </value>
                            <next>
                              <block type="variables_set">
                                <field name="VAR" id="stop_reason">stop_reason</field>
                                <value name="VALUE">
                                  <block type="text">
                                    <field name="TEXT">Stop Loss Triggered</field>
                                  </block>
                                </value>
                                <next>
                                  <block type="notify">
                                    <field name="NOTIFICATION_TYPE">error</field>
                                    <value name="MESSAGE">
                                      <block type="text">
                                        <field name="TEXT">üõë Stop Loss Triggered! Bot Stopped.</field>
                                      </block>
                                    </value>
                                  </block>
                                </next>
                              </block>
                            </next>
                          </block>
                        </statement>
                        <next>
                          
                          <!-- Check 3: Max Consecutive Losses -->
                          <block type="controls_if" id="check_consecutive_losses">
                            <value name="IF0">
                              <block type="logic_compare">
                                <field name="OP">GTE</field>
                                <value name="A">
                                  <block type="variables_get">
                                    <field name="VAR" id="consecutive_losses">consecutive_losses</field>
                                  </block>
                                </value>
                                <value name="B">
                                  <block type="variables_get">
                                    <field name="VAR" id="max_consecutive_losses">max_consecutive_losses</field>
                                  </block>
                                </value>
                              </block>
                            </value>
                            <statement name="DO0">
                              <block type="variables_set">
                                <field name="VAR" id="bot_running">bot_running</field>
                                <value name="VALUE">
                                  <block type="logic_boolean">
                                    <field name="BOOL">FALSE</field>
                                  </block>
                                </value>
                                <next>
                                  <block type="variables_set">
                                    <field name="VAR" id="stop_reason">stop_reason</field>
                                    <value name="VALUE">
                                      <block type="text">
                                        <field name="TEXT">Max Consecutive Losses</field>
                                      </block>
                                    </value>
                                    <next>
                                      <block type="notify">
                                        <field name="NOTIFICATION_TYPE">error</field>
                                        <value name="MESSAGE">
                                          <block type="text">
                                            <field name="TEXT">‚ö†Ô∏è Max Consecutive Losses Reached! Bot Stopped.</field>
                                          </block>
                                        </value>
                                      </block>
                                    </next>
                                  </block>
                                </next>
                              </block>
                            </statement>
                            <next>
                              
                              <!-- Check 4: Minimum Balance -->
                              <block type="controls_if" id="check_min_balance">
                                <value name="IF0">
                                  <block type="logic_compare">
                                    <field name="OP">LTE</field>
                                    <value name="A">
                                      <block type="balance">
                                        <field name="BALANCE_TYPE">STR_BALANCE</field>
                                      </block>
                                    </value>
                                    <value name="B">
                                      <block type="variables_get">
                                        <field name="VAR" id="min_balance">min_balance</field>
                                      </block>
                                    </value>
                                  </block>
                                </value>
                                <statement name="DO0">
                                  <block type="variables_set">
                                    <field name="VAR" id="bot_running">bot_running</field>
                                    <value name="VALUE">
                                      <block type="logic_boolean">
                                        <field name="BOOL">FALSE</field>
                                      </block>
                                    </value>
                                    <next>
                                      <block type="variables_set">
                                        <field name="VAR" id="stop_reason">stop_reason</field>
                                        <value name="VALUE">
                                          <block type="text">
                                            <field name="TEXT">Minimum Balance Reached</field>
                                          </block>
                                        </value>
                                        <next>
                                          <block type="notify">
                                            <field name="NOTIFICATION_TYPE">error</field>
                                            <value name="MESSAGE">
                                              <block type="text">
                                                <field name="TEXT">üí∞ Minimum Balance Reached! Bot Stopped.</field>
                                              </block>
                                            </value>
                                          </block>
                                        </next>
                                      </block>
                                    </next>
                                  </block>
                                </statement>
                                <next>
                                  
                                  <!-- Check 5: Max Martingale Steps -->
                                  <block type="controls_if" id="check_martingale_steps">
                                    <value name="IF0">
                                      <block type="logic_compare">
                                        <field name="OP">GTE</field>
                                        <value name="A">
                                          <block type="variables_get">
                                            <field name="VAR" id="current_martingale_step">current_martingale_step</field>
                                          </block>
                                        </value>
                                        <value name="B">
                                          <block type="variables_get">
                                            <field name="VAR" id="max_martingale_steps">max_martingale_steps</field>
                                          </block>
                                        </value>
                                      </block>
                                    </value>
                                    <statement name="DO0">
                                      <block type="variables_set">
                                        <field name="VAR" id="bot_running">bot_running</field>
                                        <value name="VALUE">
                                          <block type="logic_boolean">
                                            <field name="BOOL">FALSE</field>
                                          </block>
                                        </value>
                                        <next>
                                          <block type="variables_set">
                                            <field name="VAR" id="stop_reason">stop_reason</field>
                                            <value name="VALUE">
                                              <block type="text">
                                                <field name="TEXT">Max Martingale Steps</field>
                                              </block>
                                            </value>
                                            <next>
                                              <block type="notify">
                                                <field name="NOTIFICATION_TYPE">error</field>
                                                <value name="MESSAGE">
                                                  <block type="text">
                                                    <field name="TEXT">üìä Max Martingale Steps Reached! Bot Stopped.</field>
                                                  </block>
                                                </value>
                                              </block>
                                            </next>
                                          </block>
                                        </next>
                                      </block>
                                    </statement>
                                    <next>
                                      
                                      <!-- If all checks pass, purchase contract -->
                                      <block type="controls_if" id="purchase_if_running">
                                        <value name="IF0">
                                          <block type="variables_get">
                                            <field name="VAR" id="bot_running">bot_running</field>
                                          </block>
                                        </value>
                                        <statement name="DO0">
                                          <block type="purchase">
                                            <field name="PURCHASE_LIST">CALL</field>
                                          </block>
                                        </statement>
                                      </block>
                                      
                                    </next>
                                  </block>
                                </next>
                              </block>
                            </next>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                  
                </statement>
                <statement name="ELSE">
                  <!-- Bot stopped - show summary -->
                  <block type="notify">
                    <field name="NOTIFICATION_TYPE">warn</field>
                    <value name="MESSAGE">
                      <block type="text_join">
                        <mutation items="5"/>
                        <value name="ADD0">
                          <block type="text">
                            <field name="TEXT">üìä Session Summary | Trades: </field>
                          </block>
                        </value>
                        <value name="ADD1">
                          <block type="variables_get">
                            <field name="VAR" id="total_trades">total_trades</field>
                          </block>
                        </value>
                        <value name="ADD2">
                          <block type="text">
                            <field name="TEXT"> | P/L: $</field>
                          </block>
                        </value>
                        <value name="ADD3">
                          <block type="variables_get">
                            <field name="VAR" id="total_profit">total_profit</field>
                          </block>
                        </value>
                        <value name="ADD4">
                          <block type="text">
                            <field name="TEXT"> | Reason: </field>
                          </block>
                        </value>
                      </block>
                    </value>
                  </block>
                </statement>
              </block>
              
            </statement>
          </block>
        </statement>
      </block>
    </statement>

    <!-- AFTER PURCHASE (During contract) -->
    <statement name="DURINGPURCHASE_STACK">
      <block type="during_purchase">
        <statement name="DURINGPURCHASE_STACK">
          <block type="block_holder" id="during_purchase_holder">
            <statement name="CONTENTS">
              <!-- Wait for contract to complete -->
            </statement>
          </block>
        </statement>
      </block>
    </statement>

    <!-- AFTER SALE (Contract result handling) -->
    <statement name="AFTERSALE_STACK">
      <block type="after_purchase">
        <statement name="AFTERSALE_STACK">
          <block type="block_holder" id="after_sale_holder">
            <statement name="CONTENTS">
              
              <!-- Update total trades -->
              <block type="variables_set" id="update_total_trades">
                <field name="VAR" id="total_trades">total_trades</field>
                <value name="VALUE">
                  <block type="math_arithmetic">
                    <field name="OP">ADD</field>
                    <value name="A">
                      <block type="variables_get">
                        <field name="VAR" id="total_trades">total_trades</field>
                      </block>
                    </value>
                    <value name="B">
                      <block type="math_number">
                        <field name="NUM">1</field>
                      </block>
                    </value>
                  </block>
                </value>
                <next>
                  
                  <!-- Get last contract profit -->
                  <block type="variables_set" id="get_last_profit">
                    <field name="VAR" id="last_profit">last_profit</field>
                    <value name="VALUE">
                      <block type="read_details">
                        <field name="DETAIL_INDEX">4</field>
                      </block>
                    </value>
                    <next>
                      
                      <!-- Update total profit -->
                      <block type="variables_set" id="update_total_profit">
                        <field name="VAR" id="total_profit">total_profit</field>
                        <value name="VALUE">
                          <block type="math_arithmetic">
                            <field name="OP">ADD</field>
                            <value name="A">
                              <block type="variables_get">
                                <field name="VAR" id="total_profit">total_profit</field>
                              </block>
                            </value>
                            <value name="B">
                              <block type="variables_get">
                                <field name="VAR" id="last_profit">last_profit</field>
                              </block>
                            </value>
                          </block>
                        </value>
                        <next>
                          
                          <!-- Update current balance -->
                          <block type="variables_set" id="update_current_balance">
                            <field name="VAR" id="current_balance">current_balance</field>
                            <value name="VALUE">
                              <block type="balance">
                                <field name="BALANCE_TYPE">STR_BALANCE</field>
                              </block>
                            </value>
                            <next>
                              
                              <!-- ===== WIN/LOSS HANDLING ===== -->
                              <block type="controls_if" id="check_win_loss">
                                <mutation else="1"/>
                                
                                <!-- WIN CONDITION -->
                                <value name="IF0">
                                  <block type="logic_compare">
                                    <field name="OP">GT</field>
                                    <value name="A">
                                      <block type="variables_get">
                                        <field name="VAR" id="last_profit">last_profit</field>
                                      </block>
                                    </value>
                                    <value name="B">
                                      <block type="math_number">
                                        <field name="NUM">0</field>
                                      </block>
                                    </value>
                                  </block>
                                </value>
                                
                                <!-- WIN ACTIONS -->
                                <statement name="DO0">
                                  <!-- Update win count -->
                                  <block type="variables_set" id="update_win_count">
                                    <field name="VAR" id="win_count">win_count</field>
                                    <value name="VALUE">
                                      <block type="math_arithmetic">
                                        <field name="OP">ADD</field>
                                        <value name="A">
                                          <block type="variables_get">
                                            <field name="VAR" id="win_count">win_count</field>
                                          </block>
                                        </value>
                                        <value name="B">
                                          <block type="math_number">
                                            <field name="NUM">1</field>
                                          </block>
                                        </value>
                                      </block>
                                    </value>
                                    <next>
                                      <!-- Reset consecutive losses -->
                                      <block type="variables_set" id="reset_consecutive_losses">
                                        <field name="VAR" id="consecutive_losses">consecutive_losses</field>
                                        <value name="VALUE">
                                          <block type="math_number">
                                            <field name="NUM">0</field>
                                          </block>
                                        </value>
                                        <next>
                                          <!-- Reset stake to base -->
                                          <block type="variables_set" id="reset_stake">
                                            <field name="VAR" id="current_stake">current_stake</field>
                                            <value name="VALUE">
                                              <block type="variables_get">
                                                <field name="VAR" id="base_stake">base_stake</field>
                                              </block>
                                            </value>
                                            <next>
                                              <!-- Reset martingale step -->
                                              <block type="variables_set" id="reset_martingale_step">
                                                <field name="VAR" id="current_martingale_step">current_martingale_step</field>
                                                <value name="VALUE">
                                                  <block type="math_number">
                                                    <field name="NUM">0</field>
                                                  </block>
                                                </value>
                                                <next>
                                                  <!-- Notify win -->
                                                  <block type="notify">
                                                    <field name="NOTIFICATION_TYPE">success</field>
                                                    <value name="MESSAGE">
                                                      <block type="text_join">
                                                        <mutation items="6"/>
                                                        <value name="ADD0">
                                                          <block type="text">
                                                            <field name="TEXT">‚úÖ WIN | +$</field>
                                                          </block>
                                                        </value>
                                                        <value name="ADD1">
                                                          <block type="variables_get">
                                                            <field name="VAR" id="last_profit">last_profit</field>
                                                          </block>
                                                        </value>
                                                        <value name="ADD2">
                                                          <block type="text">
                                                            <field name="TEXT"> | Total: $</field>
                                                          </block>
                                                        </value>
                                                        <value name="ADD3">
                                                          <block type="variables_get">
                                                            <field name="VAR" id="total_profit">total_profit</field>
                                                          </block>
                                                        </value>
                                                        <value name="ADD4">
                                                          <block type="text">
                                                            <field name="TEXT"> | Bal: $</field>
                                                          </block>
                                                        </value>
                                                        <value name="ADD5">
                                                          <block type="variables_get">
                                                            <field name="VAR" id="current_balance">current_balance</field>
                                                          </block>
                                                        </value>
                                                      </block>
                                                    </value>
                                                  </block>
                                                </next>
                                              </block>
                                            </next>
                                          </block>
                                        </next>
                                      </block>
                                    </next>
                                  </block>
                                </statement>
                                
                                <!-- LOSS ACTIONS -->
                                <statement name="ELSE">
                                  <!-- Update loss count -->
                                  <block type="variables_set" id="update_loss_count">
                                    <field name="VAR" id="loss_count">loss_count</field>
                                    <value name="VALUE">
                                      <block type="math_arithmetic">
                                        <field name="OP">ADD</field>
                                        <value name="A">
                                          <block type="variables_get">
                                            <field name="VAR" id="loss_count">loss_count</field>
                                          </block>
                                        </value>
                                        <value name="B">
                                          <block type="math_number">
                                            <field name="NUM">1</field>
                                          </block>
                                        </value>
                                      </block>
                                    </value>
                                    <next>
                                      <!-- Increment consecutive losses -->
                                      <block type="variables_set" id="increment_consecutive">
                                        <field name="VAR" id="consecutive_losses">consecutive_losses</field>
                                        <value name="VALUE">
                                          <block type="math_arithmetic">
                                            <field name="OP">ADD</field>
                                            <value name="A">
                                              <block type="variables_get">
                                                <field name="VAR" id="consecutive_losses">consecutive_losses</field>
                                              </block>
                                            </value>
                                            <value name="B">
                                              <block type="math_number">
                                                <field name="NUM">1</field>
                                              </block>
                                            </value>
                                          </block>
                                        </value>
                                        <next>
                                          
                                          <!-- Apply Martingale if enabled -->
                                          <block type="controls_if" id="apply_martingale">
                                            <value name="IF0">
                                              <block type="variables_get">
                                                <field name="VAR" id="martingale_enabled">martingale_enabled</field>
                                              </block>
                                            </value>
                                            <statement name="DO0">
                                              <!-- Multiply stake -->
                                              <block type="variables_set" id="multiply_stake">
                                                <field name="VAR" id="current_stake">current_stake</field>
                                                <value name="VALUE">
                                                  <block type="math_arithmetic">
                                                    <field name="OP">MULTIPLY</field>
                                                    <value name="A">
                                                      <block type="variables_get">
                                                        <field name="VAR" id="current_stake">current_stake</field>
                                                      </block>
                                                    </value>
                                                    <value name="B">
                                                      <block type="variables_get">
                                                        <field name="VAR" id="martingale_multiplier">martingale_multiplier</field>
                                                      </block>
                                                    </value>
                                                  </block>
                                                </value>
                                                <next>
                                                  <!-- Increment martingale step -->
                                                  <block type="variables_set" id="increment_step">
                                                    <field name="VAR" id="current_martingale_step">current_martingale_step</field>
                                                    <value name="VALUE">
                                                      <block type="math_arithmetic">
                                                        <field name="OP">ADD</field>
                                                        <value name="A">
                                                          <block type="variables_get">
                                                            <field name="VAR" id="current_martingale_step">current_martingale_step</field>
                                                          </block>
                                                        </value>
                                                        <value name="B">
                                                          <block type="math_number">
                                                            <field name="NUM">1</field>
                                                          </block>
                                                        </value>
                                                      </block>
                                                    </value>
                                                  </block>
                                                </next>
                                              </block>
                                            </statement>
                                            <next>
                                              <!-- Notify loss -->
                                              <block type="notify">
                                                <field name="NOTIFICATION_TYPE">error</field>
                                                <value name="MESSAGE">
                                                  <block type="text_join">
                                                    <mutation items="8"/>
                                                    <value name="ADD0">
                                                      <block type="text">
                                                        <field name="TEXT">‚ùå LOSS | -$</field>
                                                      </block>
                                                    </value>
                                                    <value name="ADD1">
                                                      <block type="math_abs">
                                                        <value name="NUM">
                                                          <block type="variables_get">
                                                            <field name="VAR" id="last_profit">last_profit</field>
                                                          </block>
                                                        </value>
                                                      </block>
                                                    </value>
                                                    <value name="ADD2">
                                                      <block type="text">
                                                        <field name="TEXT"> | Total: $</field>
                                                      </block>
                                                    </value>
                                                    <value name="ADD3">
                                                      <block type="variables_get">
                                                        <field name="VAR" id="total_profit">total_profit</field>
                                                      </block>
                                                    </value>
                                                    <value name="ADD4">
                                                      <block type="text">
                                                        <field name="TEXT"> | Next: $</field>
                                                      </block>
                                                    </value>
                                                    <value name="ADD5">
                                                      <block type="variables_get">
                                                        <field name="VAR" id="current_stake">current_stake</field>
                                                      </block>
                                                    </value>
                                                    <value name="ADD6">
                                                      <block type="text">
                                                        <field name="TEXT"> | Step: </field>
                                                      </block>
                                                    </value>
                                                    <value name="ADD7">
                                                      <block type="variables_get">
                                                        <field name="VAR" id="current_martingale_step">current_martingale_step</field>
                                                      </block>
                                                    </value>
                                                  </block>
                                                </value>
                                              </block>
                                            </next>
                                          </block>
                                        </next>
                                      </block>
                                    </next>
                                  </block>
                                </statement>
                              </block>
                              
                            </next>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
              
            </statement>
          </block>
        </statement>
      </block>
    </statement>
  </block>
</xml>
